models:
  - name: fct_activity_data_points
    description: >
      One row per activity data point (Strava records 1 data point per second)
      where all types of streams (time, power, velocity, etc. ) have been pivoted to their own columns.
    tests:
      - dbt_utils.expression_is_true:
          expression: "time >= 0"
          config:
            where: "time is not null"
      - dbt_utils.expression_is_true:
          expression: "distance >= 0"
          config:
            where: "distance is not null"
      - dbt_utils.expression_is_true:
          expression: "stream_index >= 0"
    columns:
      - name: activity_data_point_id
        tests:
          - unique
          - not_null
      
      - name: stream_index
        tests:
          - not_null
      
      - name: is_moving
        description: >
          Flag to denote whether athlete was moving at this instance of time.
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
      
      - name: time
        tests:
          - not_null
      
      - name: grade
        description: >
          The "smoothed" (or whole number) grade provided by Strava.
          Unable to calculate an actual grade because it would require a finer granularity
          than meters for altitude (i.e. ascent often happens at a rate of < 1 m/s).
        tests:
          - not_null
      
      - name: velocity
        description: >
          The exact velocity at each stream index calculated via
          `distance_delta` / `time_delta`.
        tests:
          - not_null:
              config:
                # it's possible to have an activity with 0 total distance recorded
                # in this case, the distance at each stream index will be null
                where: "distance is not null"
      
      - name: velocity_smooth
        description: >
          The "smoothed" (or whole number) velocity provided by Strava (in meters/second).
          When the `time_delta` = 1, this is accurate; however, when the `time_delta` > 1
          (i.e. there are larger time gaps between stream indexes) this is not as accurate
          as 1 m/s = 2.2mph = 3.6 kph which can result in significant discrepencies
          between the smoothed and actual values.
      
      - name: distance_delta
        description: >
          Calculates the distance between stream points.
          For use in calcaulting the exact velocity at each stream index.
      
      - name: time_delta
        description: >
          Calculates the time bewteen stream data points.
          Ideally, a stream records 1 data point per second, however,
          this can vary based on the GPS device used (sampling rates can differ across devices),
          activity type, whether or not "battery saver" mode on the device is enabled, etc.
        tests:
          # There are small instances of time_delta = 0 as it's
          # possible (though rare) for streams to get written twice
          # (e.g. two rows for an activity where time = 300)
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: activity_id
        description: "Foreign key to fct_activities"
        tests:
          - not_null
          - relationships:
              to: ref('fct_activities')
              field: activity_id

      - name: heartrate
        description: "Heart rate at this point (may be null for activities without HR data)"
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 30 and 250"
              config:
                where: "heartrate is not null"
                severity: warn

      - name: latitude
        description: "GPS latitude coordinate"
        tests:
          - dbt_utils.expression_is_true:
              expression: "between -90 and 90"
              config:
                where: "latitude is not null"

      - name: longitude
        description: "GPS longitude coordinate"
        tests:
          - dbt_utils.expression_is_true:
              expression: "between -180 and 180"
              config:
                where: "longitude is not null"

      - name: altitude
        description: "Altitude in meters"
        tests:
          - dbt_utils.expression_is_true:
              expression: "between -500 and 9000"
              config:
                where: "altitude is not null"
                severity: warn

      - name: power
        description: "Power in watts (may be null for activities without power data)"
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 2000"
              config:
                where: "power is not null"
                severity: warn