# =============================================================================
# Promtail Configuration
# =============================================================================
# Ship Airflow task logs from /var/log/airflow to Loki.

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: airflow
    static_configs:
      - targets: ['localhost']
        labels:
          job: airflow
          __path__: /var/log/airflow/**/*.log
    pipeline_stages:
      # Extract fields from JSON logs
      - json:
          expressions:
            level: level
            event: event
            logger: logger
            trace_id: trace_id
            span_id: span_id
            trace_flags: trace_flags
            airflow_dag_id: airflow_dag_id
            airflow_task_id: airflow_task_id
            airflow_run_id: airflow_run_id
            airflow_try_number: airflow_try_number
            airflow_map_index: airflow_map_index
            airflow_logical_date: airflow_logical_date
            dlt_pipeline_name: dlt_pipeline_name
            dlt_dataset_name: dlt_dataset_name
            dlt_destination: dlt_destination
            dlt_load_id: dlt_load_id
            filename: filename
            lineno: lineno
      # Fallback regex extraction for trace context
      - regex:
          expression: '"trace_id"\s*:\s*"(?P<trace_id>[a-f0-9]{32})"'
      - regex:
          expression: '"span_id"\s*:\s*"(?P<span_id>[a-f0-9]{16})"'
      - regex:
          expression: '"trace_flags"\s*:\s*"(?P<trace_flags>[a-f0-9]{2})"'
      # Promote extracted fields to labels for efficient querying
      - labels:
          level:
          logger:
          trace_id:
          span_id:
          trace_flags:
          airflow_dag_id:
          airflow_task_id:
          airflow_run_id:
          airflow_try_number:
          airflow_map_index:
          airflow_logical_date:
          dlt_pipeline_name:
          dlt_dataset_name:
          dlt_destination:
          dlt_load_id:
